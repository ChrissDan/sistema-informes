<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #2563eb; 
            --primary-dark: #1d4ed8; 
            --sidebar-bg: #0f172a; 
            --sidebar-text: #f1f5f9; 
            --bg: #f3f4f6; 
            --danger: #ef4444; 
            --success: #22c55e; 
            --text-main: #334155;
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text-main); }
        
        .sidebar { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 4px 0 10px rgba(0,0,0,0.05); }
        .sidebar-header { padding: 25px 20px; font-size: 1.1rem; font-weight: 700; border-bottom: 1px solid #1e293b; text-align: center; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .nav-links { list-style: none; padding: 0 15px; margin: 25px 0; flex: 1; }
        .nav-links li { margin-bottom: 8px; }
        .nav-links a { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: #94a3b8; text-decoration: none; border-radius: 8px; transition: all 0.2s; cursor: pointer; font-weight: 500; }
        .nav-links a:hover, .nav-links a.active { background: var(--primary); color: white; transform: translateX(5px); }
        .nav-links a i { width: 20px; text-align: center; font-size: 1.1rem; }
        
        .user-panel { padding: 20px; border-top: 1px solid #1e293b; background: #0b1120; }
        .user-info { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .user-avatar { width: 35px; height: 35px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .btn-logout { color: #f87171; text-decoration: none; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .btn-logout:hover { color: #fca5a5; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 10px; }
        
        .section-view { display: none; animation: fadeIn 0.3s; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 25px; border: 1px solid #e2e8f0; position: relative; overflow: hidden; }
        h2 { margin-top: 0; color: #1e293b; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; font-size: 1.2rem; }
        h3 { margin-top: 0; font-size: 1.1rem; color: #475569; display: flex; align-items: center; gap: 10px; }

        .table-container { overflow-x: auto; border-radius: 10px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f8fafc; padding: 14px 20px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #64748b; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; }
        td { padding: 14px 20px; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8fafc; }

        .btn-action { width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: 0.2s; margin-right: 4px; }
        .btn-del { background: #fee2e2; color: #dc2626; }
        .btn-del:hover { background: #fecaca; }
        .btn-edit { background: #dbeafe; color: #2563eb; }
        .btn-edit:hover { background: #bfdbfe; }
        
        .btn-primary { background: var(--primary); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        
        .btn-cancel { background: #e2e8f0; color: #475569; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; display: none; font-weight: 500; margin-left: 10px; }
        .btn-cancel:hover { background: #cbd5e1; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        label { display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 8px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 0.95rem; transition: border-color 0.2s; background: #fff; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        input:disabled { background-color: #f1f5f9; cursor: not-allowed; color: #94a3b8; }

        .month-nav { display: flex; align-items: center; justify-content: center; background: #fff; padding: 8px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 20px; width: fit-content; margin-left: auto; margin-right: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .month-title { font-weight: 700; font-size: 1rem; margin: 0 20px; min-width: 140px; text-align: center; color: #1e293b; }
        .btn-nav { background: transparent; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; color: #64748b; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .btn-nav:hover { background: #f1f5f9; color: var(--primary); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0; position: relative; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .stat-icon { position: absolute; top: -10px; right: -10px; font-size: 5rem; color: #f1f5f9; z-index: 0; opacity: 0.5; }
        .stat-content { position: relative; z-index: 1; }
        .stat-card h4 { margin: 0 0 5px 0; color: #64748b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .stat-value { font-size: 2.5rem; font-weight: 800; color: #0f172a; margin-bottom: 5px; }
        .stat-detail { margin-top: 15px; padding-top: 15px; border-top: 1px solid #f1f5f9; font-size: 0.9rem; color: #475569; display: flex; justify-content: space-between; }
        
        .groups-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .group-item { background: white; border: 1px solid #e2e8f0; padding: 15px 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; }
        .group-name { font-weight: 600; color: #334155; font-size: 0.95rem; }
        .progress-bar-bg { width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .group-perc { font-weight: 700; color: var(--primary); margin-left: 15px; min-width: 45px; text-align: right; }

        .admin-only { display: none; }
        .badge { padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .badge-si { background: #dcfce7; color: #15803d; } .badge-no { background: #fee2e2; color: #b91c1c; }
        .badge-gray { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .badge-grp { background: #e0e7ff; color: #4338ca; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <i class="fa-solid fa-layer-group"></i>
            <span id="sidebarTitle">Gestión Cong.</span>
        </div>
        
        <ul class="nav-links">
            <li><a onclick="showView('dashboard')" class="active" id="nav-dashboard"><i class="fa-solid fa-chart-pie"></i> Dashboard</a></li>
            <li><a onclick="showView('informes')" id="nav-informes"><i class="fa-solid fa-file-lines"></i> Informes</a></li>
            <li><a onclick="showView('publicadores')" id="nav-publicadores"><i class="fa-solid fa-users"></i> Publicadores</a></li>
            <li class="admin-only"><a onclick="showView('usuarios')" id="nav-usuarios"><i class="fa-solid fa-user-shield"></i> Usuarios</a></li>
        </ul>
        
        <div class="user-panel">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div style="overflow:hidden;">
                    <div id="userName" style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Cargando...</div>
                    <div id="userRole" style="font-size:0.75rem; color:#94a3b8;">...</div>
                </div>
            </div>
            <a id="btnLogoutSide" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión</a>
        </div>
    </nav>

    <main class="main-content">
        <header>
            <h1 id="pageTitle"><i class="fa-solid fa-gauge-high" style="color:var(--primary)"></i> Panel de Control</h1>
        </header>
        
        <div id="view-dashboard" class="section-view active">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #f1f5f9; padding-bottom:15px;">
                    <h3><i class="fa-solid fa-calendar-day"></i> Resumen Mensual</h3>
                    <select id="dashMesSelect" onchange="cargarDashboard()" style="width:auto; padding:8px 30px 8px 12px; font-weight:600; color:var(--primary); border-color:var(--primary); cursor:pointer; background-image:none;"></select>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fa-solid fa-person-walking stat-icon"></i>
                        <div class="stat-content">
                            <h4>PUB + PNB</h4>
                            <div class="stat-value" id="stat-pub-count">0</div>
                            <div class="stat-detail">
                                <span><i class="fa-solid fa-book"></i> Cursos: <strong id="stat-pub-cursos">0</strong></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fa-solid fa-stopwatch stat-icon"></i>
                        <div class="stat-content">
                            <h4>AUXILIARES</h4>
                            <div class="stat-value" id="stat-aux-count">0</div>
                            <div class="stat-detail">
                                <span><i class="fa-regular fa-clock"></i> <strong id="stat-aux-horas">0</strong>h</span>
                                <span><i class="fa-solid fa-book"></i> <strong id="stat-aux-cursos">0</strong></span>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <i class="fa-solid fa-briefcase stat-icon"></i>
                        <div class="stat-content">
                            <h4>REGULARES</h4>
                            <div class="stat-value" id="stat-reg-count">0</div>
                            <div class="stat-detail">
                                <span><i class="fa-regular fa-clock"></i> <strong id="stat-reg-horas">0</strong>h</span>
                                <span><i class="fa-solid fa-book"></i> <strong id="stat-reg-cursos">0</strong></span>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-top:40px; margin-bottom:20px;"><i class="fa-solid fa-chart-bar"></i> Progreso de Informes</h3>
                <div id="groups-progress-container" class="groups-grid"></div>
            </div>
        </div>

        <div id="view-informes" class="section-view">
            <div class="card">
                <h3 id="tituloFormInforme"><i class="fa-solid fa-circle-plus"></i> Nuevo Informe</h3>
                <form id="formInforme" class="form-grid">
                    <input type="hidden" name="id" id="informeId">
                    <div class="admin-only" style="grid-column: 1/-1;">
                        <label>Grupo (Admin):</label>
                        <select id="infGrupoSelect" onchange="cargarPublicadoresSelect(this.value)">
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            <option value="7">7</option><option value="8">8</option>
                        </select>
                    </div>
                    <div><label>Mes</label><select name="mes" id="formMesSelect" required></select></div>
                    <div style="grid-column: span 2"><label>Publicador</label><select id="selectPubInfo" name="publicador_id" required onchange="cargarDatosPub()"><option value="">Cargando...</option></select></div>
                    <div><label>Privilegio</label><input id="readPriv3" readonly style="background:#f8fafc; color:#64748b;"></div>
                    <div><label>¿Predicó?</label><select name="predico" required><option value="">-</option><option value="SI">SÍ</option><option value="NO">NO</option></select></div>
                    <div><label>Horas</label><input type="number" name="horas" id="inputHoras" step="0.5" min="0"></div>
                    <div><label>Cursos</label><input type="number" name="cursos" min="0"></div>
                    <div style="grid-column: 1/-1"><label>Comentario</label><input name="comentarios" placeholder="Notas adicionales..."></div>
                    <div style="grid-column: 1/-1; display:flex; gap:10px;">
                        <button type="submit" class="btn-primary" id="btnSaveInfo"><i class="fa-solid fa-floppy-disk"></i> Guardar Informe</button>
                        <button type="button" class="btn-cancel" id="btnCancelInfo" onclick="resetFormInforme()"><i class="fa-solid fa-xmark"></i> Cancelar</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3><i class="fa-solid fa-clock-rotate-left"></i> Historial</h3>
                    <div class="month-nav">
                        <button class="btn-nav" onclick="cambiarMes(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                        <div id="labelMesActual" class="month-title">...</div>
                        <button class="btn-nav" onclick="cambiarMes(1)"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <button class="btn-action btn-edit" style="width:auto; padding:0 12px; gap:5px;" onclick="cargarTablaInformes()"><i class="fa-solid fa-rotate"></i> Recargar</button>
                </div>
                <div class="table-container">
                    <table><thead><tr><th class="admin-only">Grp</th><th>Nombre</th><th>Priv</th><th>Hrs</th><th>Cur</th><th>Pred</th><th>Comentario</th><th>Acciones</th></tr></thead><tbody id="tablaInformes"></tbody></table>
                </div>
            </div>
        </div>

        <div id="view-publicadores" class="section-view">
            <div class="card admin-only">
                <h3 id="tituloFormPub"><i class="fa-solid fa-user-plus"></i> Agregar Publicador</h3>
                <form id="formPublicador" class="form-grid">
                    <input type="hidden" name="id" id="pubId">
                    <div class="admin-only"><label>Grupo</label><select id="pubGrupoSelect" name="grupo_manual"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
                    <div style="grid-column: span 2"><label>Nombre Completo</label><input name="nombre" required></div>
                    <div><label>Priv 1</label><select name="priv1"><option value="">-</option><option value="SG">SG</option><option value="AXG">AXG</option></select></div>
                    <div><label>Priv 2</label><select name="priv2"><option value="">-</option><option value="A">A</option><option value="SM">SM</option></select></div>
                    <div><label>Priv 3</label><select name="priv3"><option>PUB</option><option>REG</option><option>AUX</option><option>AUX I</option><option>AUX M</option><option>PNB</option></select></div>
                    <div><label>¿Informó?</label><select name="informo"><option value="SI">SI</option><option value="NO">NO</option></select></div>
                    <div style="grid-column: span 2"><label>Comentario</label><input name="comentario"></div>
                    <div style="align-self:end; display:flex; gap:10px;">
                        <button type="submit" class="btn-primary" id="btnSavePub"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
                        <button type="button" class="btn-cancel" id="btnCancelPub" onclick="resetFormPub()"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3><i class="fa-solid fa-list"></i> Lista Detallada</h3>
                <div class="table-container">
                    <table><thead><tr><th>Grp</th><th>Nombre</th><th>P1</th><th>P2</th><th>P3</th><th>Info?</th><th>Acciones</th></tr></thead><tbody id="tablaPublicadores"></tbody></table>
                </div>
            </div>
        </div>

        <div id="view-usuarios" class="section-view">
            <div class="card">
                <h3 id="tituloFormUser"><i class="fa-solid fa-user-shield"></i> Crear Usuario</h3>
                <form id="formUsuario" class="form-grid">
                    <input type="hidden" name="id" id="userId">
                    <div><label>Nombre</label><input name="nombre" required></div>
                    <div><label>Correo</label><input name="correo" type="email" required></div>
                    <div><label>Contraseña</label><input name="password" required></div>
                    <div><label>Grupo</label><select name="grupo"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="0">0 (Admin)</option></select></div>
                    <div style="align-self:end; display:flex; gap:10px;">
                        <button type="submit" class="btn-primary" id="btnSaveUser"><i class="fa-solid fa-plus"></i> Crear</button>
                        <button type="button" class="btn-cancel" id="btnCancelUser" onclick="resetFormUser()"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </form>
            </div>
            <div class="card"><h3><i class="fa-solid fa-users-gear"></i> Lista Usuarios</h3><table><thead><tr><th>Nombre</th><th>Correo</th><th>Grupo</th><th>Clave</th><th>Acciones</th></tr></thead><tbody id="tablaUsuarios"></tbody></table></div>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const session = JSON.parse(localStorage.getItem('user_session'));
        if (!session) window.location.href = '/index.html';

        function logout() { localStorage.removeItem('user_session'); window.location.href = '/index.html'; }
        document.getElementById('btnLogoutSide').addEventListener('click', logout);

        const isAdmin = session.grupo === 0;
        
        // --- PERSONALIZACIÓN UI ---
        const sidebarTitle = document.getElementById('sidebarTitle');
        if(isAdmin) {
            sidebarTitle.textContent = "ADMINISTRADOR";
            document.getElementById('userRole').textContent = "Acceso Total";
        } else {
            sidebarTitle.textContent = "GRUPO " + session.grupo;
            document.getElementById('userRole').textContent = "Encargado";
        }
        document.getElementById('userName').textContent = session.nombre;
        document.getElementById('userAvatar').textContent = session.nombre.charAt(0).toUpperCase();

        if (isAdmin) {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            document.querySelectorAll('th.admin-only').forEach(el => el.style.display = 'table-cell');
        } else {
            document.getElementById('nav-usuarios').parentElement.style.display = 'none';
        }

        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true
        });

        const MESES = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
        let mesIndexActual = new Date().getMonth();
        
        const formMesSelect = document.getElementById('formMesSelect');
        const dashMesSelect = document.getElementById('dashMesSelect');
        
        formMesSelect.innerHTML = '<option value="">-- Seleccione --</option>';
        MESES.forEach(m => { 
            const opt = document.createElement('option'); opt.value = m; opt.textContent = m; 
            formMesSelect.appendChild(opt); 
            dashMesSelect.appendChild(opt.cloneNode(true));
        });
        dashMesSelect.value = MESES[mesIndexActual];

        function cambiarMes(direccion) {
            mesIndexActual += direccion;
            if (mesIndexActual > 11) mesIndexActual = 0; if (mesIndexActual < 0) mesIndexActual = 11;
            cargarTablaInformes();
        }

        function showView(viewName) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            document.getElementById(`nav-${viewName}`).classList.add('active');
            
            const titles = { 'dashboard': 'Dashboard General', 'informes': 'Gestión de Informes', 'publicadores': 'Directorio Publicadores', 'usuarios': 'Administración Usuarios' };
            const icons = { 'dashboard': 'gauge-high', 'informes': 'file-lines', 'publicadores': 'users', 'usuarios': 'user-shield' };
            document.getElementById('pageTitle').innerHTML = `<i class="fa-solid fa-${icons[viewName]}" style="color:var(--primary)"></i> ${titles[viewName]}`;

            if (viewName === 'informes') { cargarTablaInformes(); cargarPublicadoresSelect(isAdmin ? 1 : session.grupo); }
            if (viewName === 'publicadores') cargarTablaPublicadores();
            if (viewName === 'usuarios') cargarTablaUsuarios();
            if (viewName === 'dashboard') cargarDashboard();
        }

        // --- DASHBOARD ---
        async function cargarDashboard() {
            const mes = document.getElementById('dashMesSelect').value;
            const grp = isAdmin ? 0 : session.grupo; 
            const res = await fetch(`/api/dashboard?mes=${mes}&grupo=${grp}`);
            const data = await res.json();

            document.getElementById('stat-pub-count').textContent = data.stats.pub.count;
            document.getElementById('stat-pub-cursos').textContent = data.stats.pub.cursos || 0;
            document.getElementById('stat-aux-count').textContent = data.stats.aux.count;
            document.getElementById('stat-aux-horas').textContent = data.stats.aux.horas || 0;
            document.getElementById('stat-aux-cursos').textContent = data.stats.aux.cursos || 0;
            document.getElementById('stat-reg-count').textContent = data.stats.reg.count;
            document.getElementById('stat-reg-horas').textContent = data.stats.reg.horas || 0;
            document.getElementById('stat-reg-cursos').textContent = data.stats.reg.cursos || 0;

            const container = document.getElementById('groups-progress-container');
            container.innerHTML = '';
            
            const gruposInfo = {};
            data.groups.totals.forEach(g => gruposInfo[g.grupo] = { total: g.total, reported: 0 });
            data.groups.reports.forEach(g => { if(gruposInfo[g.grupo]) gruposInfo[g.grupo].reported = g.count; });

            Object.keys(gruposInfo).forEach(grpNum => {
                if(grpNum == 0) return;
                const g = gruposInfo[grpNum];
                const percent = Math.round((g.reported / g.total) * 100) || 0;
                let color = 'var(--primary)';
                if(percent === 100) color = 'var(--success)';
                if(percent < 50) color = 'var(--danger)';

                const item = document.createElement('div');
                item.className = 'group-item';
                item.innerHTML = `
                    <div class="group-info">
                        <div class="group-name">Grupo ${grpNum} <span style="font-weight:400; font-size:0.85em; color:#64748b;">(${g.reported}/${g.total})</span></div>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${percent}%; background:${color}"></div></div>
                    </div>
                    <div class="group-perc" style="color:${color}">${percent}%</div>
                `;
                container.appendChild(item);
            });
        }

        let cachePublicadores = [];
        let cacheInformes = [];
        let cacheUsuarios = [];

        async function cargarPublicadoresSelect(grupoId) {
            try {
                const res = await fetch(`/api/publicadores?grupo=${grupoId}`);
                cachePublicadores = await res.json();
                const sel = document.getElementById('selectPubInfo');
                const currentVal = sel.value;
                sel.innerHTML = '<option value="">-- Seleccione --</option>';
                cachePublicadores.forEach(p => { sel.innerHTML += `<option value="${p.id}">${p.nombre}</option>`; });
                if(currentVal && cachePublicadores.find(p=>p.id==currentVal)) sel.value = currentVal;
            } catch(e) { console.error(e); }
        }

        function cargarDatosPub() {
            const id = document.getElementById('selectPubInfo').value;
            const pub = cachePublicadores.find(p => p.id == id);
            if(pub) { 
                document.getElementById('readPriv3').value = pub.priv3;
                actualizarEstadoHoras(pub.priv3);
            } else {
                document.getElementById('readPriv3').value = "";
                document.getElementById('inputHoras').disabled = true;
            }
        }

        function actualizarEstadoHoras(privilegio) {
            const inputHoras = document.getElementById('inputHoras');
            const p = (privilegio || "").trim().toUpperCase();
            const reportan = ['ESP', 'REG', 'AUX I', 'AUX M', 'AUX'];
            if (reportan.includes(p)) { inputHoras.disabled = false; } 
            else { inputHoras.disabled = true; inputHoras.value = ""; }
        }

        async function cargarTablaInformes() {
            const nombreMes = MESES[mesIndexActual];
            document.getElementById('labelMesActual').textContent = nombreMes;
            if(formMesSelect.value === "") formMesSelect.value = nombreMes;

            const grp = isAdmin ? 0 : session.grupo;
            const res = await fetch(`/api/informes?grupo=${grp}&mes=${nombreMes}`);
            cacheInformes = await res.json();
            
            const tbody = document.getElementById('tablaInformes');
            tbody.innerHTML = '';

            if (cacheInformes.length === 0) { tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:30px; color:#94a3b8;"><i class="fa-solid fa-inbox" style="font-size:2rem; display:block; margin-bottom:10px;"></i>No hay informes registrados en ${nombreMes}.</td></tr>`; return; }

            cacheInformes.forEach(d => {
                const badge = d.predico === 'SI' ? '<span class="badge badge-si"><i class="fa-solid fa-check"></i> SÍ</span>' : '<span class="badge badge-no"><i class="fa-solid fa-xmark"></i> NO</span>';
                const grpCell = isAdmin ? `<td><span class="badge-grp">G${d.grupo}</span></td>` : '';
                const deleteBtn = isAdmin ? `<button class="btn-action btn-del" onclick="eliminar('informes', ${d.id})" title="Eliminar"><i class="fa-solid fa-trash-can"></i></button>` : '';
                const editBtn = `<button class="btn-action btn-edit" onclick="editarInforme(${d.id})" title="Editar"><i class="fa-solid fa-pen-to-square"></i></button>`;
                tbody.innerHTML += `<tr>${grpCell}<td>${d.nombre_publicador || d.publicador_nombre}</td><td><span class="badge badge-gray">${d.priv3}</span></td><td style="text-align:center"><b>${d.horas}</b></td><td style="text-align:center">${d.cursos}</td><td style="text-align:center">${badge}</td><td style="font-size:0.8em; color:#666;">${d.comentarios || ''}</td><td>${editBtn} ${deleteBtn}</td></tr>`;
            });
        }

        function editarInforme(id) {
            const obj = cacheInformes.find(i => i.id == id);
            if(!obj) return;
            const f = document.getElementById('formInforme');
            document.getElementById('informeId').value = obj.id;
            f.mes.value = obj.mes;
            const processEdit = () => {
                f.publicador_id.value = obj.publicador_id;
                cargarDatosPub();
                f.predico.value = obj.predico;
                f.horas.value = obj.horas;
                f.cursos.value = obj.cursos;
                f.comentarios.value = obj.comentarios;
            };
            if(isAdmin) {
                document.getElementById('infGrupoSelect').value = obj.grupo;
                cargarPublicadoresSelect(obj.grupo).then(processEdit);
            } else { processEdit(); }
            document.getElementById('tituloFormInforme').innerHTML = `<i class="fa-solid fa-pen"></i> Editar Informe`;
            document.getElementById('btnSaveInfo').innerHTML = `<i class="fa-solid fa-rotate"></i> Actualizar`;
            document.getElementById('btnSaveInfo').style.background = "#d97706";
            document.getElementById('btnCancelInfo').style.display = "inline-flex";
            document.getElementById('btnCancelInfo').style.alignItems = "center";
            document.getElementById('btnCancelInfo').style.gap = "5px";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetFormInforme() {
            document.getElementById('formInforme').reset();
            document.getElementById('informeId').value = "";
            document.getElementById('tituloFormInforme').innerHTML = `<i class="fa-solid fa-circle-plus"></i> Nuevo Informe`;
            document.getElementById('btnSaveInfo').innerHTML = `<i class="fa-solid fa-floppy-disk"></i> Guardar Informe`;
            document.getElementById('btnSaveInfo').style.background = "";
            document.getElementById('btnCancelInfo').style.display = "none";
            document.getElementById('inputHoras').disabled = true; 
        }

        document.getElementById('formInforme').addEventListener('submit', async (e) => {
            e.preventDefault();
            const f = e.target;
            const rawData = Object.fromEntries(new FormData(f));
            rawData.horas = f.horas.disabled ? 0 : (f.horas.value || 0);
            rawData.cursos = f.cursos.value || 0;
            const id = document.getElementById('informeId').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/informes/${id}` : '/api/informes';
            rawData.grupo = isAdmin ? document.getElementById('infGrupoSelect').value : session.grupo;
            if(!id) {
                const pub = cachePublicadores.find(p => p.id == rawData.publicador_id);
                if(pub) { rawData.publicador_nombre = pub.nombre; rawData.priv1 = pub.priv1; rawData.priv2 = pub.priv2; rawData.priv3 = pub.priv3; }
            }
            const res = await fetch(url, { method: method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(rawData)});
            if(res.ok) { Toast.fire({ icon: 'success', title: id ? 'Informe actualizado' : 'Informe guardado' }); resetFormInforme(); cargarTablaInformes(); }
            else { Swal.fire('Error', 'No se pudo guardar', 'error'); }
        });

        async function cargarTablaPublicadores() {
            const grp = isAdmin ? 0 : session.grupo;
            const res = await fetch(`/api/publicadores?grupo=${grp}`);
            cachePublicadores = await res.json();
            const tbody = document.getElementById('tablaPublicadores');
            tbody.innerHTML = '';
            cachePublicadores.forEach(d => {
                const infoBadge = (d.informo === 'SI') ? '<span class="badge badge-si"><i class="fa-solid fa-check"></i> SÍ</span>' : '<span class="badge badge-no"><i class="fa-solid fa-xmark"></i> NO</span>';
                const deleteBtn = isAdmin ? `<button class="btn-action btn-del" onclick="eliminar('publicadores', ${d.id})" title="Eliminar"><i class="fa-solid fa-trash-can"></i></button>` : '';
                const editBtn = isAdmin ? `<button class="btn-action btn-edit" onclick="editarPub(${d.id})" title="Editar"><i class="fa-solid fa-pen-to-square"></i></button>` : '';
                tbody.innerHTML += `<tr><td><b>${d.grupo}</b></td><td style="font-weight:500">${d.nombre}</td><td>${d.priv1 || '-'}</td><td>${d.priv2 || '-'}</td><td><span class="badge badge-gray">${d.priv3}</span></td><td>${infoBadge}</td><td>${editBtn} ${deleteBtn}</td></tr>`;
            });
        }

        function editarPub(id) {
            if(!isAdmin) return;
            const obj = cachePublicadores.find(p => p.id == id);
            if(!obj) return;
            const f = document.getElementById('formPublicador');
            document.getElementById('pubId').value = obj.id;
            document.getElementById('pubGrupoSelect').value = obj.grupo;
            f.nombre.value = obj.nombre;
            f.priv1.value = obj.priv1; f.priv2.value = obj.priv2; f.priv3.value = obj.priv3;
            f.informo.value = obj.informo;
            f.comentario.value = obj.comentario;
            document.getElementById('tituloFormPub').innerHTML = `<i class="fa-solid fa-pen"></i> Editar Publicador`;
            document.getElementById('btnSavePub').innerHTML = `<i class="fa-solid fa-rotate"></i> Actualizar`;
            document.getElementById('btnCancelPub').style.display = "inline-flex";
            document.getElementById('btnCancelPub').style.alignItems = "center";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetFormPub() {
            document.getElementById('formPublicador').reset();
            document.getElementById('pubId').value = "";
            document.getElementById('tituloFormPub').innerHTML = `<i class="fa-solid fa-user-plus"></i> Agregar Publicador`;
            document.getElementById('btnSavePub').innerHTML = `<i class="fa-solid fa-floppy-disk"></i> Guardar`;
            document.getElementById('btnCancelPub').style.display = "none";
        }

        document.getElementById('formPublicador').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            const id = document.getElementById('pubId').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/publicadores/${id}` : '/api/publicadores';
            data.grupo = isAdmin ? document.getElementById('pubGrupoSelect').value : session.grupo;
            data.requester_group = session.grupo; 
            const res = await fetch(url, { method: method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)});
            const json = await res.json();
            if(json.ok) { Toast.fire({ icon: 'success', title: id ? 'Publicador actualizado' : 'Publicador creado' }); resetFormPub(); cargarTablaPublicadores(); }
            else { Swal.fire('Error', json.msg, 'error'); }
        });

        async function cargarTablaUsuarios() {
            if (!isAdmin) return;
            const res = await fetch('/api/usuarios');
            cacheUsuarios = await res.json();
            const tbody = document.getElementById('tablaUsuarios');
            tbody.innerHTML = '';
            cacheUsuarios.forEach(d => {
                const editBtn = `<button class="btn-action btn-edit" onclick="editarUser(${d.id})" title="Editar"><i class="fa-solid fa-pen-to-square"></i></button>`;
                tbody.innerHTML += `<tr><td>${d.nombre}</td><td>${d.correo}</td><td>Grupo ${d.grupo}</td><td>${d.password}</td><td>${editBtn} <button class="btn-action btn-del" onclick="eliminar('usuarios', ${d.id})" title="Eliminar"><i class="fa-solid fa-trash-can"></i></button></td></tr>`;
            });
        }

        function editarUser(id) {
            const obj = cacheUsuarios.find(u => u.id == id);
            if(!obj) return;
            const f = document.getElementById('formUsuario');
            document.getElementById('userId').value = obj.id;
            f.nombre.value = obj.nombre;
            f.correo.value = obj.correo;
            f.password.value = obj.password;
            f.grupo.value = obj.grupo;
            document.getElementById('tituloFormUser').innerHTML = `<i class="fa-solid fa-pen"></i> Editar Usuario`;
            document.getElementById('btnSaveUser').innerHTML = `<i class="fa-solid fa-rotate"></i> Actualizar`;
            document.getElementById('btnCancelUser').style.display = "inline-flex";
            document.getElementById('btnCancelUser').style.alignItems = "center";
        }

        function resetFormUser() {
            document.getElementById('formUsuario').reset();
            document.getElementById('userId').value = "";
            document.getElementById('tituloFormUser').innerHTML = `<i class="fa-solid fa-user-shield"></i> Crear Usuario`;
            document.getElementById('btnSaveUser').innerHTML = `<i class="fa-solid fa-plus"></i> Crear`;
            document.getElementById('btnCancelUser').style.display = "none";
        }

        document.getElementById('formUsuario').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            const id = document.getElementById('userId').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/usuarios/${id}` : '/api/usuarios';
            await fetch(url, { method: method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)});
            Toast.fire({ icon: 'success', title: id ? 'Usuario actualizado' : 'Usuario creado' }); resetFormUser(); cargarTablaUsuarios();
        });

        async function eliminar(entidad, id) {
            const result = await Swal.fire({
                title: '¿Estás seguro?', text: "Esta acción no se puede deshacer.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#ef4444', cancelButtonColor: '#94a3b8',
                confirmButtonText: 'Sí, eliminar', cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                const res = await fetch(`/api/${entidad}/${id}`, { 
                    method: 'DELETE',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ requester_group: session.grupo })
                });
                const json = await res.json();
                if(json.ok) {
                    Toast.fire({ icon: 'success', title: 'Eliminado correctamente' });
                    if(entidad === 'informes') cargarTablaInformes();
                    if(entidad === 'publicadores') cargarTablaPublicadores();
                    if(entidad === 'usuarios') cargarTablaUsuarios();
                } else {
                    Swal.fire('Error', json.msg, 'error');
                }
            }
        }

        showView('dashboard');
    </script>

</body>
</html>